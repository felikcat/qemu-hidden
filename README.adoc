:experimental:
:imagesdir: images
ifdef::env-github[]
:icons:
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
:toc:
endif::[]

== About
This guide's goal is to provide you with a very high-quality VM setup, and to bypass some anti-VM measures without slowing down performance.

The guide built on CachyOS using systemd-boot or Limine (recommended) and KDE Plasma desktop.

The host GPU is from AMD, while the guest (VM / Virtual Machine / VFIO) GPU is from NVIDIA.

NOTE: These instructions also work for GPUs from Intel or AMD, but there's no advice on resolving the reset bug or other problems they may have inside a virtual machine.


== 1. Installing Hypervisor Phantom

NOTE: Always install required missing packages, and keep the source to make repatching quicker.

. `git clone --single-branch --depth=1 https://github.com/Scrut1ny/Hypervisor-Phantom && cd Hypervisor-Phantom/ && chmod -R +x *`
. `sudo ./main.sh`
. Select QEMU (Patched) Setup.
. Build & install QEMU to /usr/local/bin [y/n]: **y**

. Select EDK2 (Patched) Setup.
. When asked to apply host's or custom, choose host's.

. Select Auto Libvirt XML Setup.
. This will generate a VM for you called 'win10', we're going to copy some things from it to put in our VM config later on.

. The kernel setup is skipped unless you absolutely need it. You'll know for yourself later on.

== [Optional] GPU passthrough
Programs such as OBS Studio will keep trying to use NVIDIA drivers instead of the AMD drivers if the LIBVA_DRIVER_NAME is still set to nvidia, in which the libva-nvidia-driver package enforces; for OBS, this means you can't record using GPU hardware acceleration: +
`sudo pacman -R libva-nvidia-driver`

Create the directory if it doesn't exist: +
`mkdir -p ~/.config/environment.d`

Edit `~/.config/environment.d/99-amdgpu.conf`
----
LIBVA_DRIVER_NAME=radeonsi
----

`sudo rm /etc/profile.d/nvidia-vaapi.sh`

This will fix the AMD GPU issue with OBS Studio after a reboot (don't reboot now).

Find the IDs to pass to vfio-pci for your guest GPU: +
`lspci -vnn`

For this example, you would passthrough the IDs `10de:2705` and `10de:22bb`:
----
05:00.0 VGA compatible controller [0300]: NVIDIA Corporation AD103 [GeForce RTX 4070 Ti SUPER] [10de:2705] (rev a1) (prog-if 00 [VGA controller])
        Subsystem: Gigabyte Technology Co., Ltd Device [1458:413d]
        Flags: bus master, fast devsel, latency 0, IRQ 101, IOMMU group 21
        Memory at dd000000 (32-bit, non-prefetchable) [size=16M]
        Memory at f800000000 (64-bit, prefetchable) [size=16G]
        Memory at fc00000000 (64-bit, prefetchable) [size=32M]
        I/O ports at e000 [size=128]
        Expansion ROM at de000000 [virtual] [disabled] [size=512K]
        Capabilities: <access denied>
        Kernel driver in use: nvidia
        Kernel modules: nouveau, nvidia_drm, nvidia

05:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:22bb] (rev a1)
        Subsystem: Gigabyte Technology Co., Ltd Device [1458:413d]
        Flags: bus master, fast devsel, latency 0, IRQ 169, IOMMU group 21
        Memory at de080000 (32-bit, non-prefetchable) [size=16K]
        Capabilities: <access denied>
        Kernel driver in use: snd_hda_intel
        Kernel modules: snd_hda_intel
----

Sudo edit: `/etc/modprobe.d/vfio.conf`
----
softdep drm pre: vfio-pci
softdep nvidia pre: vfio-pci
softdep amdgpu pre: vfio-pci
softdep snd_hda_intel pre: vfio-pci

# Change these PCIe IDs to yours!
options vfio-pci ids=10de:2705,10de:22bb
----

Sudo edit: `/etc/mkinitcpio.conf`
----
# Replace MODULES=() with the following:
# MODULES=(vfio_pci vfio vfio_iommu_type1)
# If you already have modules in there, put the new vfio entries before those modules.

# Check to see if 'modconf' is already included in HOOKS=(), it's necessary.
----

== 2. Virtual machine requisites

Sudo edit: `/etc/sysctl.d/99-qemu.conf`
----
# Prevents GPU timeouts or other VM hanging while running video games.
kernel.split_lock_mitigate=0

# Replicates the value set by default in SteamOS. Not strictly necessary but here just incase.
vm.max_map_count = 2147483642
----

Sudo edit: `/etc/modprobe.d/qemu.conf`
----
# Prevents Windows BSODs and performance decreases in instances of MSRs faults.
options kvm ignore_msrs=Y report_ignored_msrs=N kvmclock_periodic_sync=N

# Improves VM performance and lowers DPC latency drastically.
options kvm_amd npt=1 avic=1

# Pause Loop Exit is useful when the CPU is overcommitted (with how a gaming VM is setup, it won't be), such as multiple VMs accessing the same CPU affinities; this lowers DPC latency, which is important for gaming.
options kvm_intel ple_gap=0 ple_window=0
----

Sudo edit `/etc/sdboot-manage.conf.d/99-qemu.conf` or `/etc/default/limine` (do not append LINUX_OPTIONS="" if using Limine):
----
# Remove intel_iommu=on and intel_pstate=disable if using an AMD CPU.
# Disabling pstates reduces stutters in VMs but can slightly decrease performance outside of the VM
LINUX_OPTIONS="intel_iommu=on iommu=pt tsc=reliable no_timer_check intel_pstate=disable amd_pstate=disable"
----

Apply the bootloader kernel option changes: +
`sudo sdboot-manage gen` or `sudo limine-mkinitcpio`

(Unnecessary on Limine) Apply the new modprobe.d and mkinitcpio.conf changes: +
`sudo mkinitcpio -P`

Reboot your PC: +
`reboot`

.Install the necessary packages: +
* `sudo pacman -Syu virt-manager iptables-nft dnsmasq virglrenderer hwloc dmidecode usbutils swtpm samba`

Assign your user to the correct groups to prevent issues in the future: +
`sudo usermod -a -G qemu,video,kvm,libvirt,libvirt-qemu "$USER"`

Sudo edit: `/etc/libvirt/network.conf`, and change `firewall_backend` to `iptables`. This is necessary since we're using iptables-nft and not nftables standalone.

Enable and start the required services to use Virtual Machine Manager: +
`sudo systemctl enable --now libvirtd.service`


== 3. Virtual machine setup

The operating system of choice either CachyOS or Windows 10 LTSC 2019 (get that from the MyDigitalLife forums). Please don't use Windows 11, it https://borncity.com/win/2025/06/18/windows-11-server-2025-june-2025-updates-cause-bsod-in-proxmox-kvm-qemu/[will not work] without purposefully sacrificing your performance after the June 2025 updates.

Enable XML editing in Virtual Machine Manager before doing anything else: Edit -> Preferences -> Check "Enable XML editing", then close.

If you plan to use CachyOS / a Linux distro in a VM, ensure in "Display Spice" that OpenGL is checked and the "Listen type" is set to 'None'; unless you're doing GPU passthrough, then don't do this.

WARNING: Make sure the disk type is virtio before installing Windows, otherwise you have to follow these steps to correct this mistake later for higher performance: https://superuser.com/a/1253728 +
- Be sure that the Video 'VGA' is used inorder to see any graphical output in Safe Mode, you can revert to Video 'None' afterwards.

Ensure the disk file location you'll use for the VM is mounted to `/mnt` instead of `/run/media`, or you could pass-through an entire NVMe disk. Up to you.

When creating a disk file, ensure its Format is 'raw' instead of 'qcow', and https://www.gbmb.org/tb-to-gib[use this calculator] to get exact disk size measurements. VirtualBox is the only good option for snapshots in my opinion, so if you do malware analysis, that's the way to go.

For Windows: Add an additional SATA CDROM to the VM, so you can load the latest `virtio-win-*.iso` into it; get the ISO from https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/?C=M;O=D[here]. At first this is used so you have disk drivers, but later on you can install all of its drivers inside of the VM by running `virtio-win-guest-tools` (after Windows is installed).

Add the PCI Host Device for your NVIDIA GPU and its accompanying audio device.

WARNING: DO NOT install any operating system for now, we need to configure the VM config first.


== 4. Optimizing VM performance and hiding the VM from some software

Looking Glass has https://looking-glass.io/docs/B7/install_libvirt/#keyboard-mouse-display-audio[its own recommendations], follow those in addition to what my guide recommends below.

For the XML changes below, here is the topology of the 9800X3D CPU used (relevant for the CPU pinning): +
image:lstopo.png[]

NOTE: You can give ChatGPT or a different AI a screenshot of your lstopo for it to tell you what's the correct <vcpupin> and CPU core isolation order; ask for both.

Show the hardware topology to understand what your CPU's pinning would look like, but make sure to press kbd:[f] if there appears to be missing CPU cores: +
`lstopo`

Bring up the VM called 'win10' that Phantom Hypervisor created, we're going to edit it:
----
  # Put after </currentMemory>
  <memoryBacking>
    <hugepages/>
    <nosharepages/>
    <locked/>
    <allocation mode="immediate"/>
  </memoryBacking>

  # Put underneath </vcpu>.
  # <vcpusched> will crash the PC if the CPU pinning is wrong; that does not mean remove it!
  <iothreads>1</iothreads>
  <cputune>
    <vcpupin vcpu="0" cpuset="1"/>
    <vcpupin vcpu="1" cpuset="9"/>
    <vcpupin vcpu="2" cpuset="2"/>
    <vcpupin vcpu="3" cpuset="10"/>
    <vcpupin vcpu="4" cpuset="3"/>
    <vcpupin vcpu="5" cpuset="11"/>
    <vcpupin vcpu="6" cpuset="4"/>
    <vcpupin vcpu="7" cpuset="12"/>
    <vcpupin vcpu="8" cpuset="5"/>
    <vcpupin vcpu="9" cpuset="13"/>
    <vcpupin vcpu="10" cpuset="6"/>
    <vcpupin vcpu="11" cpuset="14"/>
    <vcpusched vcpus="0-11" scheduler="rr" priority="99"/>
    <emulatorpin cpuset="0,8"/>
    <iothreadpin iothread="1" cpuset="15"/>
  </cputune>

  # Replace <clock> with this:
  <clock offset="localtime">
    <timer name="tsc" tickpolicy="discard" mode="native"/>
    <timer name="rtc" tickpolicy="catchup"/>
    <timer name="pit" tickpolicy="delay"/>
    <timer name="hpet" present="no"/>
    <timer name="kvmclock" present="yes"/>
    <timer name="hypervclock" present="yes"/>
  </clock>
  
  # Remove stimer to support nested VMs (for further anti-VM detections), which you do by enabling Virtual Machine Platform in "Turn Windows features on or off"
  # - Change AuthenticAMD to GenuineIntel if using an Intel CPU!
  <features>
    <acpi/>
    <apic/>
    <hyperv mode="custom">
      <relaxed state="on"/>
      <vapic state="on"/>
      <spinlocks state="on" retries="8191"/>
      <vpindex state="on"/>
      <runtime state="on"/>
      <synic state="on"/>
      <stimer state="on">
        <direct state="on"/>
      </stimer>
      <reset state="on"/>
      <vendor_id state="on" value="AuthenticAMD"/>
      <frequencies state="on"/>
      <reenlightenment state="on"/>
      <tlbflush state="on">
        <direct state="on"/>
        <extended state="on"/>
      </tlbflush>
      <ipi state="on"/>
      <avic state="on"/>
      <emsr_bitmap state="on"/>
      <xmm_input state="on"/>
    </hyperv>
    <kvm>
      <hidden state="on"/>
      <hint-dedicated state="on"/>
      <poll-control state="on"/>
      <pv-ipi state="off"/>
      <dirty-ring state="on" size="4096"/>
    </kvm>
    <pmu state="off"/>
    <vmport state="off"/>
    <smm state="on"/>
    <ioapic driver="kvm"/>
    <msrs unknown="fault"/>
  </features>

  # Change the cores to the amount allocated to the VM; 16 cores would be cores="8".
  # Remove "svm" if using an Intel CPU, otherwise remove "vmx" if using an AMD CPU.
  <cpu mode="host-passthrough" check="none" migratable="off">
    <topology sockets="1" dies="1" clusters="1" cores="6" threads="2"/>
    <cache mode="passthrough"/>
    <feature policy="require" name="svm"/>
    <feature policy="require" name="vmx"/>
    <feature policy="require" name="topoext"/>
    <feature policy="require" name="invtsc"/>
    <feature policy="require" name="hypervisor"/>
    <feature policy="disable" name="vmx-vnmi"/>
    <feature policy="disable" name="ssbd"/>
    <feature policy="disable" name="amd-ssbd"/>
    <feature policy="disable" name="virt-ssbd"/>
    <feature policy="disable" name="rdtscp"/>
    <feature policy="disable" name="rdpid"/>
  </cpu>

  # If you are using Looking Glass:
  # Replace <audio id="1" type="none"/> with:
  <audio id="1" type="spice"/>
  # Be sure to add Graphics -> Spice Server (with default settings) inorder to use this!

  # Put inside <devices>
  <panic model="hyperv"/>

  # Remove the entire <shmem name="looking-glass"> block; it's an old and slower method of running LG

  # Put inside <qemu:commandline>, "cpu-pm=on" helps with CPU performance. 
  # Side effect: the host says the VM's CPU cores are always 100% usage
  <qemu:arg value="-overcommit"/>
  <qemu:arg value="cpu-pm=on"/>

  # More optimal settings for virtio on NVMe drives
  # Be sure your disk is 'raw' instead of 'qcow2', if it is 'qcow2', convert it to 'raw'
  <disk type="file" device="disk">
    <driver name="qemu" type="raw" cache="none" io="native" discard="unmap" iothread="1" queues="8"/>
    <source file="/mnt/nvme/win11.img"/>
    <target dev="vda" bus="virtio"/>
  </disk>

  # Under <interface type="network">, ensure the model type is "virtio"
----

=== 5. Setup the QEMU hook for automatic: CPU isolation, 2MB hugepages, CPU performance scheduler
* `sudo mkdir -p /etc/libvirt/hooks`

* Sudo edit `/etc/libvirt/hooks/qemu`, and change the variables to match your configuration:
----
#!/bin/bash

# -------------------------
# CPU topology configuration
# -------------------------

# VM gets these logical cores; never allocate 0 or 1
# I would recommend giving AI an image of your lstopo to set this and HOST_CORES
VM_CORES="2-7,10-15"

# Host keeps these logical cores; always use at least 4 cores
HOST_CORES="0-1,8-9"

# Total available system cores
ALL_CORES="0-15"

# VM memory in MB (used for hugepages)
VM_MEMORY="16384"

command=$2

# -------------------------
# Function: allocate hugepages
# -------------------------
allocate_hugepages() {
  HP_KB=$(grep Hugepagesize /proc/meminfo | awk '{print $2}')
  HP_MB=$((HP_KB / 1024))

  HUGEPAGES=$(( VM_MEMORY / HP_MB ))

  echo "Allocating hugepages: $HUGEPAGES pages ($VM_MEMORY MB / ${HP_MB}MB pagesize)"

  echo $HUGEPAGES > /proc/sys/vm/nr_hugepages

  ALLOC_PAGES=$(cat /proc/sys/vm/nr_hugepages)
  TRIES=0

  while (( ALLOC_PAGES != HUGEPAGES && TRIES < 1024 ))
  do
    echo $HUGEPAGES > /proc/sys/vm/nr_hugepages
    ALLOC_PAGES=$(cat /proc/sys/vm/nr_hugepages)
    echo "Allocated $ALLOC_PAGES / $HUGEPAGES"
    (( TRIES++ ))
  done

  if [ "$ALLOC_PAGES" -ne "$HUGEPAGES" ]; then
    echo "Hugepages allocation failed. Reverting..."
    echo 0 > /proc/sys/vm/nr_hugepages
    exit 1
  fi
}

# -------------------------
# Event: PREPARE
# -------------------------
if [ "$command" = "prepare" ]; then

  # Allocate hugepages BEFORE isolating CPUs
  vfio-isolate \
    drop-caches
  allocate_hugepages

  # Isolate VM cores but keep host on HOST_CORES
  vfio-isolate -u /tmp/vfio_isolate_history \
    cpu-governor performance C${ALL_CORES} \
    cpuset-modify --cpus C${HOST_CORES} /system.slice \
    cpuset-modify --cpus C${HOST_CORES} /user.slice \
    cpuset-modify --cpus C${HOST_CORES} /init.scope \
    irq-affinity mask C${VM_CORES}

  echo "CPU isolation complete."
  echo "Host cores: $HOST_CORES"
  echo "VM cores:   $VM_CORES"

# -------------------------
# Event: RELEASE
# -------------------------
elif [ "$command" = "release" ]; then
  echo "Releasing VFIO isolation..."
  vfio-isolate restore /tmp/vfio_isolate_history

  # Incase vfio-isolate restore failed
  vfio-isolate \
    cpuset-modify --cpus C${ALL_CORES} /system.slice \
    cpuset-modify --cpus C${ALL_CORES} /user.slice \
    cpuset-modify --cpus C${ALL_CORES} /init.scope \
    irq-affinity mask C${ALL_CORES}

  echo "Dropping hugepages..."
  echo 0 > /proc/sys/vm/nr_hugepages

  echo "Done."
fi

----

* Restart libvirtd to ensure it recognizes the new hook, and ensure the file permissions are correct: +
`sudo chmod +x /etc/libvirt/hooks/qemu; sudo systemctl restart virtqemud.service libvirtd.service`


== [Optional] Cloning the VM
Shut down the VM, then choose 'Virtual Machine' -> 'Clone'.

== [Optional] Looking Glass setup

`paru -S looking-glass looking-glass-module-dkms obs-plugin-looking-glass`

https://looking-glass.io/docs/B7/ivshmem_kvmfr/[Follow through the official documentation] but skip past the "Installing" step as you've already done that the Arch way.

NOTE: Run `sudo chmod 0660 /dev/kvmfr0` if you're getting permission errors for `/dev/kvmfr0` from QEMU.

Install the Looking Glass Host to the Windows or Linux VM, and run it.

Be sure to plug in a display port into the passed through GPU, otherwise Looking Glass will not work. It could be a real HDMI or DisplayPort plug (recommended), or a dummy plug.

NOTE: All the client options are listed here: https://looking-glass.io/docs/B7/usage/

To stop the annoyance of getting asked to allow the microphone and hide the microphone icon, and to reduce the audio delay, edit: `~/.config/looking-glass/client.ini`:
----
[audio]
micDefault=allow
micShowIndicator=no
bufferLatency=0
----

Ensure the display scaling in KDE Plasma is set to intervals of 25%, otherwise Looking Glass will look blurry (such as on 115% scaling instead of 125% scaling).

=== Increasing disk performance
* If your disk is type="qcow2", you can convert to "raw" for additional performance; the disks are likely in `/var/lib/libvirt/images`, if so then you also need to use `sudo` before the command: +
`qemu-img convert -f qcow2 -O raw DISK_NAME_HERE.qcow2 DISK_NAME_HERE.raw`
- This will allocate the full space of the disk, you could add `-S 0` before `DISK_NAME_HERE.qcow2` but it's not recommended to use "sparse" disks as there's a performance loss.

* For Btrfs, ZFS, or bcachefs filesystems, we'll disable CoW (Copy on Write) for the directory the disks are located in: +
`sudo chattr +C /var/lib/libvirt/images`

=== Lower audio delay and stuttering
* For Windows: Go into the old audio settings ("More sound settings" in Windows 11), right-click "Speakers" and click "Properties", then in "Enhancements" disable all enhancements and in "Advanced" ensure the Default Format is: 16 bit, 48000 Hz.

=== Increasing Looking Glass performance
* For Windows: Enable HAGS (Hardware Accelerated GPU Scheduling), disable Game Mode, set High Performance in the Power Options, disable Dynamic Ticks and set TSC Sync Policy to enhanced then reboot: +
`bcdedit /deletevalue useplatformclock` +
`bcdedit /deletevalue useplatformtick` +
`bcdedit /set disabledynamictick yes` +
`bcdedit /set tscsyncpolicy enhanced`

* Put in `~/.config/looking-glass/client.ini`:
----
[win]
jitRender=1

[egl]
noSwapDamage=1

----

=== Looking Glass is crashing / the VM freezes
Update your NVIDIA drivers in the VM.

=== Go into the Windows VM and do the following:
- Run "Edit group policy". Go to Computer Configuration -> Administrative Templates -> System -> Device Guard -> Turn On Virtualization Based Security, and set it to "Enabled". Ensure "Select Platform Security Level" is set to "Secure Boot", and the rest of the options are left as "Not Configured".
- Run "Turn Windows features on or off". Ensure that "Guarded Host", "Hyper-V", "Virtual Machine Platform", "Windows Hypervisor Platform", "Windows Sandbox", and "Windows Subsystem for Linux" is left unchecked as these features will lower performance.

== [Optional] Sharing files to the Windows VM without enabling shared memory (for better performance)

Edit: `/etc/samba/smb.conf`
----
[global]
# Security
client min protocol = SMB3
## SMB3_11 is also faster than previous versions.
server min protocol = SMB3
## Allow local IPs.
hosts allow = 192.168.0.0/16
## Deny all other IPs.
hosts deny = 0.0.0.0/0
restrict anonymous = 2
disable netbios = Yes
dns proxy = No
# Performance
use sendfile = Yes
## Don't use outside local IPs! 
smb encrypt = No
# Other
server role = standalone server
# Disable printer support
disable spoolss = Yes
load printers = No
printcap name = /dev/null
show add printer wizard = No
printing = bsd

# 'share1' is what Windows 10 will see in its file manager.
[share1]
path = /directory/to/folder
read only = No
## If the user is not 'admin', rename the group and user.
force group = admin
force user = admin
----

Validate the SMB server config, it should return no errors: +
`testparm`

Add an SMB login for your username. It's recommended to use a different password than your real Linux password: +
`sudo smbpasswd -a $USER`

Allow the SMB ports through the firewall: +
`sudo ufw allow 445; sudo ufw allow 139`

Enable and start the SaMBa service: +
`sudo systemctl enable --now smb.service`

Find the correct local IP address to connect to inside the Windows VM for the file sharing; for me the interface was "enp14s0": +
`ip a`

Open the 'Run' program in the Windows VM, and run: `\\192.168.50.179` (replace with your local IP that was shown earlier).
